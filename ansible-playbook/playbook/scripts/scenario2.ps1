$Global:Users = @('Chuck','Lorre','Leonard','Hofstadter','Sheldon','Cooper','Penny','Hofstadter','Howard','Wolowitz','Rajesh','Koothrappali','Amy','FarrahFowler','Stuart','Bloom','Emily','Sweeney','Bernadette','Wolowitz','President','Siebert');
$Global:BadPasswords = @('123123', 'baseball', 'abc123', 'football', 'monkey', 'letmein', '696969', 'shadow', 'master', '666666', 'qwertyuiop', '123321', 'mustang', '1234567890', 'michael', '654321', 'pussy', 'superman', '1qaz2wsx', '7777777', 'fuckyou', '121212', '000000', 'qazwsx', '123qwe', 'killer', 'trustno1', 'jordan', 'jennifer', 'zxcvbnm', 'asdfgh', 'hunter', 'buster', 'soccer', 'harley', 'batman', 'andrew', 'tigger', 'sunshine', 'iloveyou', 'fuckme', '2000', 'charlie', 'robert', 'thomas', 'hockey', 'ranger', 'daniel', 'starwars', 'klaster', '112233', 'george', 'asshole', 'computer', 'michelle', 'jessica', 'pepper', '1111', 'zxcvbn', '555555', '11111111', '131313', 'freedom', '777777', 'pass', 'fuck', 'maggie', '159753', 'aaaaaa', 'ginger', 'princess', 'joshua', 'cheese', 'amanda', 'summer', 'love', 'ashley', '6969', 'nicole', 'chelsea', 'biteme', 'matthew', 'access', 'yankees', '987654321', 'dallas', 'austin', 'thunder', 'taylor', 'matrix', 'william', 'corvette', 'hello', 'martin', 'heather', 'secret', 'fucker', 'merlin', 'diamond', '1234qwer', 'gfhjkm', 'hammer', 'silver', '222222', '88888888', 'anthony', 'justin', 'test', 'bailey', 'q1w2e3r4t5', 'patrick', 'internet', 'scooter', 'orange', '11111', 'golfer', 'cookie', 'richard', 'samantha', 'bigdog', 'guitar', 'jackson', 'whatever', 'mickey', 'chicken', 'sparky', 'snoopy', 'maverick', 'phoenix', 'camaro', 'sexy', 'peanut', 'morgan', 'welcome', 'falcon', 'cowboy', 'ferrari', 'samsung', 'andrea', 'smokey', 'steelers', 'joseph', 'mercedes', 'dakota', 'arsenal', 'eagles', 'melissa', 'boomer', 'booboo', 'spider', 'nascar', 'monster', 'tigers', 'yellow', 'xxxxxx', '123123123', 'gateway', 'marina', 'diablo', 'bulldog', 'qwer1234', 'compaq', 'purple', 'hardcore', 'banana', 'junior', 'hannah', '123654', 'porsche', 'lakers', 'iceman', 'money', 'cowboys', '987654', 'london', 'tennis', '999999', 'ncc1701', 'coffee', 'scooby', '0000', 'miller', 'boston', 'q1w2e3r4', 'fuckoff', 'brandon', 'yamaha', 'chester', 'mother', 'forever', 'johnny', 'edward', '333333', 'oliver', 'redsox', 'player', 'nikita', 'knight', 'fender', 'barney', 'midnight', 'please', 'brandy', 'chicago', 'badboy', 'iwantu', 'slayer', 'rangers', 'charles', 'angel', 'flower', 'bigdaddy', 'rabbit', 'wizard', 'bigdick', 'jasper', 'enter', 'rachel', 'chris', 'steven', 'winner', 'adidas', 'victoria', 'natasha', '1q2w3e4r', 'jasmine', 'winter', 'prince', 'panties', 'marine', 'ghbdtn', 'fishing', 'cocacola', 'casper', 'james', '232323', 'raiders', '888888', 'marlboro', 'gandalf', 'asdfasdf', 'crystal', '87654321', '12344321', 'sexsex', 'golden', 'blowme', 'bigtits', '8675309', 'panther', 'lauren', 'angela', 'bitch', 'spanky', 'thx1138', 'angels', 'madison', 'winston', 'shannon', 'mike', 'toyota', 'blowjob', 'jordan23', 'canada', 'sophie', 'Password', 'apples', 'dick', 'tiger', 'razz', '123abc', 'pokemon', 'qazxsw', '55555', 'qwaszx', 'muffin', 'johnson', 'murphy', 'cooper', 'jonathan', 'liverpoo', 'david', 'danielle', '159357', 'jackie', '1990', '123456a', '789456', 'turtle', 'horny', 'abcd1234', 'scorpion', 'qazwsxedc', '101010', 'butter', 'carlos', 'password1', 'dennis', 'slipknot', 'qwerty123', 'booger', 'asdf', '1991', 'black', 'startrek', '12341234', 'cameron', 'newyork', 'rainbow', 'nathan', 'john', '1992', 'rocket', 'viking', 'redskins', 'butthead', 'asdfghjkl', '1212', 'sierra', 'peaches', 'gemini', 'doctor', 'wilson', 'sandra', 'helpme', 'qwertyui', 'victor', 'florida', 'dolphin', 'pookie', 'captain', 'tucker', 'blue', 'liverpool', 'theman', 'bandit', 'dolphins', 'maddog', 'packers', 'jaguar', 'lovers', 'nicholas', 'united', 'tiffany', 'maxwell', 'zzzzzz', 'nirvana', 'jeremy', 'suckit', 'stupid', 'porn', 'monica', 'elephant', 'giants', 'jackass', 'hotdog', 'rosebud', 'success', 'debbie', 'mountain', '444444', 'xxxxxxxx', 'warrior', '1q2w3e4r5t', 'q1w2e3', '123456q', 'albert', 'metallic', 'lucky', 'azerty', '7777', 'shithead', 'alex', 'bond007', 'alexis', '1111111', 'samson', '5150', 'willie', 'scorpio', 'bonnie', 'gators', 'benjamin', 'voodoo', 'driver', 'dexter', '2112', 'jason', 'calvin', 'freddy', '212121', 'creative', '12345a', 'sydney', 'rush2112', '1989', 'asdfghjk', 'red123', 'bubba', '4815162342', 'passw0rd', 'trouble', 'gunner', 'happy', 'fucking', 'gordon', 'legend', 'jessie', 'stella', 'qwert', 'eminem', 'arthur', 'apple', 'nissan', 'bullshit', 'bear', 'america', '1qazxsw2', 'nothing', 'parker', '4444', 'rebecca', 'qweqwe', 'garfield', '01012011', 'beavis', '69696969', 'jack', 'asdasd', 'december', '2222', '102030', '252525', '11223344', 'magic', 'apollo', 'skippy', '315475', 'girls', 'kitten', 'golf', 'copper', 'braves', 'shelby', 'godzilla', 'beaver', 'fred', 'tomcat', 'august', 'buddy', 'airborne', '1993', '1988', 'lifehack', 'qqqqqq', 'brooklyn', 'animal', 'platinum', 'phantom', 'online', 'xavier', 'darkness', 'blink182', 'power', 'fish', 'green', '789456123', 'voyager', 'police', 'travis', '12qwaszx', 'heaven', 'snowball', 'lover', 'abcdef', '00000', 'pakistan', '007007', 'walter', 'playboy', 'blazer', 'cricket', 'sniper', 'hooters', 'donkey', 'willow', 'loveme', 'saturn', 'therock', 'redwings');
$Global:Groups = @('Caltech Council','Backup Apartment Key','Apartment Key','Scientists','Engineers','University','Cheese Cake Factory','Comics');
$Global:BadACL = @('GenericAll','GenericWrite','WriteOwner','WriteDACL','Self','WriteProperty','User-Force-Change-Password');
$Global:CreatedUsers = @();
$Global:AllObjects = @();

$Global:Domain = "";
$Global:DAUser = "";
$Global:DAPassword = "";
$Global:Server1 = "";
$Global:Server2 = "";
$Global:Server3 = "";

#Strings 
$Global:Spacing = "`t"
$Global:PlusLine = "`t[+]"
$Global:ErrorLine = "`t[-]"
$Global:InfoLine = "`t[*]"
function Write-Good { param( $String ) Write-Host $Global:PlusLine  $String -ForegroundColor 'Green'}
function Write-Bad  { param( $String ) Write-Host $Global:ErrorLine $String -ForegroundColor 'red'  }
function Write-Info { param( $String ) Write-Host $Global:InfoLine $String -ForegroundColor 'gray' }
function ShowBanner {
    $banner  = @()
    $banner+= $Global:Spacing + ''
    $banner+= $Global:Spacing + 'VULN AD - Vulnerable Active Directory'
    $banner+= $Global:Spacing + ''                                                  
    $banner+= $Global:Spacing + 'By wazehell @safe_buffer'
    $banner | foreach-object {
        Write-Host $_ -ForegroundColor (Get-Random -Input @('Green','Cyan','Yellow','gray','white'))
    }                             
}
function VulnAD-GetRandom {
   Param(
     [array]$InputList
   )
   return Get-Random -InputObject $InputList
}

function VulnAD-AddADUser {
    Add-Type -AssemblyName System.Web
    for ($i=0; $i -lt $Global:Users.length; $i=$i+2) {
        $firstname = $Global:Users[$i];
        $lastname = $Global:Users[$i+1];
        $fullname = "{0} {1}" -f ($firstname , $lastname);
        $SamAccountName = ("{0}.{1}" -f ($firstname, $lastname)).ToLower();
        $principalname = "{0}.{1}" -f ($firstname, $lastname);
        $generated_password = ([System.Web.Security.Membership]::GeneratePassword(12,2))
        Write-Info "Creating $SamAccountName User"
        Try { New-ADUser -Name "$firstname $lastname" -GivenName $firstname -Surname $lastname -SamAccountName $SamAccountName -UserPrincipalName $principalname@$Global:Domain -AccountPassword (ConvertTo-SecureString $generated_password -AsPlainText -Force) -PassThru | Enable-ADAccount } Catch {}
        $Global:CreatedUsers += $SamAccountName;
        
        # Save Domain Admin Password for later
        $Global:DAUser = $Global:CreatedUsers[0];
	$Global:DAPassword = ([System.Web.Security.Membership]::GeneratePassword(12,2));
	Set-AdAccountPassword -Identity $Global:DAUser -Reset -NewPassword (ConvertTo-SecureString $Global:DAPassword -AsPlainText -Force)
    }

}

function VulnAD-AddADGroup {
    foreach ($group in $Global:Groups) {
        Write-Info "Creating $group Group"
        Try { New-ADGroup -name $group -GroupScope Global } Catch {}
        }
    $Global:AllObjects += $group;
    Try { Add-ADGroupMember -Identity $Global:Groups[0] -Members $Global:CreatedUsers[10] } Catch {}
    Try { Add-ADGroupMember -Identity $Global:Groups[1] -Members $Global:CreatedUsers[3] } Catch {}
    Try { Add-ADGroupMember -Identity $Global:Groups[2] -Members $Global:CreatedUsers[1],$Global:CreatedUsers[2],$Global:Groups[1] } Catch {}
    Try { Add-ADGroupMember -Identity $Global:Groups[3] -Members $Global:CreatedUsers[1],$Global:CreatedUsers[2],$Global:CreatedUsers[5],$Global:CreatedUsers[6]$Global:CreatedUsers[9] } Catch {}
    Try { Add-ADGroupMember -Identity $Global:Groups[4] -Members $Global:CreatedUsers[4] } Catch {}
    Try { Add-ADGroupMember -Identity $Global:Groups[5] -Members $Global:Groups[3],$Global:Groups[4],$Global:CreatedUsers[10] } Catch {}
    Try { Add-ADGroupMember -Identity $Global:Groups[6] -Members $Global:CreatedUsers[3] } Catch {}
    Try { Add-ADGroupMember -Identity $Global:Groups[7] -Members $Global:CreatedUsers[1],$Global:CreatedUsers[2],$Global:CreatedUsers[4],$Global:CreatedUsers[5],$Global:CreatedUsers[7] } Catch {}
    Try { Add-ADGroupMember -Identity 'Domain Admins' -Members $Global:CreatedUsers[0] } Catch {}
}

function VulnAD-AddACL {
        [CmdletBinding()]
        param(
            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string]$Destination,

            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [System.Security.Principal.IdentityReference]$Source,

            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string]$Rights

        )
        $ADObject = [ADSI]("LDAP://" + $Destination)
        $identity = $Source
        $adRights = [System.DirectoryServices.ActiveDirectoryRights]$Rights
        $type = [System.Security.AccessControl.AccessControlType] "Allow"
        $inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "All"
        $ACE = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$inheritanceType
        $ADObject.psbase.ObjectSecurity.AddAccessRule($ACE)
        $ADObject.psbase.commitchanges()
}

function VulnAD-AddACLExtended {
        [CmdletBinding()]
        param(
            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string]$Destination,

            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [System.Security.Principal.IdentityReference]$Source,

            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string]$Rights

        )
        $objectGuid = New-Object Guid $Rights
        $ADObject = [ADSI]("LDAP://" + $Destination)
        $identity = $Source
        $adRights = [System.DirectoryServices.ActiveDirectoryRights]"ExtendedRight"
        $type = [System.Security.AccessControl.AccessControlType] "Allow"
        $inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "All"
        $ACE = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$objectGuid,$inheritanceType
        $ADObject.psbase.ObjectSecurity.AddAccessRule($ACE)
        $ADObject.psbase.commitchanges()
}


function VulnAD-BadAcls {
	# User-Force-Change-Password
	$abuse = "00299570-246d-11d0-a768-00aa006e0529"
	$srcuser = "emily.sweeney"
	$destuser = "rajesh.koothrappali"
	$Dstobj = Get-ADUser -Identity $destuser
	$Srcobj = Get-ADUser -Identity $srcuser
	VulnAD-AddACLExtended -Source $Srcobj.sid -Destination $Dstobj.DistinguishedName -Rights $abuse 
        Write-Info "BadACL $abuse $srcuser and $destuser"
        $srcuser = "howard.wolowitz"
        $Srcobj = Get-ADUser -Identity $srcuser
        VulnAD-AddACLExtended -Source $Srcobj.sid -Destination $Dstobj.DistinguishedName -Rights $abuse 
        Write-Info "BadACL $abuse $srcuser and $destuser"
        
        # Self
        $abuse = "Self"
	$srcuser = "rajesh.koothrappali"
	$destgroup = "Backup Apartment Key"
        $DstGroup = Get-ADGroup -Identity $destgroup
        $SrcObj= Get-ADUser -Identity $srcuser
        VulnAD-AddACL -Source $SrcObj.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $srcuser to $destgroup"
        
        $srcuser = "howard.wolowitz"
        $SrcObj= Get-ADUser -Identity $srcuser
        VulnAD-AddACL -Source $SrcObj.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $srcuser to $destgroup"
        
        $srcuser = "bernadette.wolowitz"
	$destgroup = "Cheese Cake Factory"
        $DstGroup = Get-ADGroup -Identity $destgroup
        $SrcObj= Get-ADUser -Identity $srcuser
        VulnAD-AddACL -Source $SrcObj.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $srcuser to $destgroup"

	# WriteOwner
	$abuse = "WriteOwner"
	$srcuser = "stuart.bloom"
	$destgroup = "Apartment Key"
        $DstGroup = Get-ADGroup -Identity $destgroup
        $SrcObj= Get-ADUser -Identity $srcuser
        VulnAD-AddACL -Source $SrcObj.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $srcuser to $destgroup"
        
        $srcuser = "sheldon.cooper"
        $SrcObj= Get-ADUser -Identity $srcuser
        VulnAD-AddACL -Source $SrcObj.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $srcuser to $destgroup"
        
        # WriteProperty
        $abuse = "WriteProperty"
	$srcuser = "president.siebert"
	$destgroup = "University"
        $DstGroup = Get-ADGroup -Identity $destgroup
        $SrcObj= Get-ADUser -Identity $srcuser
        VulnAD-AddACL -Source $SrcObj.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $srcuser to $destgroup"
        
	$srcgroup = "Engineers"
	$destgroup = "Caltech Council"
        $DstGroup = Get-ADGroup -Identity $destgroup
        $SrcGroup = Get-ADGroup -Identity $srcgroup
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $srcgroup to $destgroup"
        
        $srcgroup = "Scientists"
	$destgroup = "Comics"
	$DstGroup = Get-ADGroup -Identity $destgroup
        $SrcGroup = Get-ADGroup -Identity $srcgroup
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $abuse $srcgroup to $destgroup"
}

function VulnAD-Kerberoasting {
	$user = "emily.sweeney"
	$selected_service = "CLINIC"
	$selected_service2 = "doctor"
	$password = VulnAD-GetRandom -InputList $Global:BadPasswords;
	Set-AdAccountPassword -Identity $user -Reset -NewPassword (ConvertTo-SecureString $password -AsPlainText -Force)
	Write-Info "Kerberoasting $user $selected_service $password"
	Try { Set-ADUser -Identity $user -ServicePrincipalNames @{Add="$selected_service/$selected_service2.$Global:Domain"} } Catch {}
    
	$user = "stuart.bloom"
	$selected_service = "SHOP"
	$selected_service2 = "manager"
	Write-Info "Fake Kerberoasting $user $selected_service $password"
	Try { Set-ADUser -Identity $user -ServicePrincipalNames @{Add="$selected_service/$selected_service2.$Global:Domain"} } Catch {}
}

function VulnAD-FakeGPOs {
	New-GPO -Name "CALTECH - Caltech Council local admin."
	New-GPO -Name "HOME - Apartment Key local admin."
}

function VulnAD-Server1 {
	$secure_da_pwd = ConvertTo-SecureString $Global:DAPassword -AsPlainText -Force
	$da_cred = New-Object System.Management.Automation.PSCredential("$Global:Domain\$Global:DAUser",$secure_da_pwd)
	
	Invoke-Command -ComputerName $Global:Server1 -Credential $da_cred -ScriptBlock {
  		net localgroup /add "Administrators" "TBBT\Caltech Council"
	}
	
	schtasks /create /sc minute /mo 5 /ru "$Global:Domain\$Global:DAUser" /rp "$Global:DAPassword" /Tn 'SimpleList' /Tr "powershell.exe -c 'Invoke-Command -Computer $Global:Server1 {dir}'"
	
	Get-ADComputer -Identity $Global:Server1 | Set-ADAccountControl -TrustedForDelegation $true
}

function VulnAD-Server2 {
	$secure_da_pwd = ConvertTo-SecureString $Global:DAPassword -AsPlainText -Force
	$da_cred = New-Object System.Management.Automation.PSCredential("$Global:Domain\$Global:DAUser",$secure_da_pwd)

	Add-Type -AssemblyName System.Web
	$domain = $Global:Domain
	$user = "howard.wolowitz"
	$generated_password = ([System.Web.Security.Membership]::GeneratePassword(12,2))
	Set-AdAccountPassword -Identity $user -Reset -NewPassword (ConvertTo-SecureString $generated_password -AsPlainText -Force)
	Invoke-Command -ComputerName $Global:Server2 -Credential $da_cred -ScriptBlock {
		net localgroup /add "Administrators" "TBBT\Apartment Key"
  		& "C:\Program Files\Autologon\autologon.exe" /accepteula $Using:user $Using:domain $Using:generated_password 
	}
}

function VulnAD-Server3 {
	$secure_da_pwd = ConvertTo-SecureString $Global:DAPassword -AsPlainText -Force
	$da_cred = New-Object System.Management.Automation.PSCredential("$Global:Domain\$Global:DAUser",$secure_da_pwd)

	$user = "testuser"
	$password = "TbbtUser123!"
	Invoke-Command -ComputerName $Global:Server3 -Credential $da_cred -ScriptBlock {
  		net user /add $Using:user $Using:password
  		net localgroup /add "ServiceManagers" $Using:user
  		net localgroup /add "Remote Desktop Users" $Using:user
	}
	
	Add-Type -AssemblyName System.Web
	$domain = $Global:Domain
	$user = "amy.farrahfowler"
	$generated_password = ([System.Web.Security.Membership]::GeneratePassword(12,2))
	Set-AdAccountPassword -Identity $user -Reset -NewPassword (ConvertTo-SecureString $generated_password -AsPlainText -Force)
	Invoke-Command -ComputerName $Global:Server3 -Credential $da_cred -ScriptBlock {
  		& "C:\Program Files\Autologon\autologon.exe" /accepteula $Using:user $Using:domain $Using:generated_password 
	}
}

function VulnAD-DisableSMBSigning {
    Set-SmbClientConfiguration -RequireSecuritySignature 0 -EnableSecuritySignature 0 -Confirm -Force
}
function Invoke-VulnAD {
    ShowBanner
    $Global:Domain = "tbbt.adlab.org"
    $Global:Server1 = "CALTECH"
    $Global:Server2 = "HOME"
    $Global:Server3 = "TEST"
    
    
    Set-ADDefaultDomainPasswordPolicy -Identity $Global:Domain -LockoutDuration 00:01:00 -LockoutObservationWindow 00:01:00 -ComplexityEnabled $false -ReversibleEncryptionEnabled $False -MinPasswordLength 4
    
    VulnAD-AddADUser
    Write-Good "Users Created"
    VulnAD-AddADGroup
    Write-Good "Groups Created"
    VulnAD-BadAcls
    Write-Good "BadACL Done"
    VulnAD-Kerberoasting
    Write-Good "Kerberoasting Done"
    VulnAD-DisableSMBSigning
    Write-Good "SMB Signing Disabled"
    VulnAD-FakeGPOs
    Write-Good "Fake GPOs Created"
    VulnAD-Server1
    Write-Good "Server1 Created"
    VulnAD-Server2
    Write-Good "Server2 Created"
    VulnAD-Server3
    Write-Good "Server3 Created"
}
Invoke-VulnAD
